<svg viewBox="0 0 1700 1100" xmlns="http://www.w3.org/2000/svg">
  <!-- Dark background -->
  <rect width="1700" height="1100" fill="#1a1a1a"/>
  
  <!-- Define arrow markers -->
  <defs>
    <!-- Diagonal stripe pattern for ephemeral state -->
    <pattern id="diagonalStripes" patternUnits="userSpaceOnUse" width="8" height="8">
      <path d="M-2,2 l4,-4 M0,8 l8,-8 M6,10 l4,-4" stroke="#888" stroke-width="1.5"/>
    </pattern>
    
    <!-- Blue arrow for forward routing -->
    <marker id="arrowBlue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#4a9eff" />
    </marker>
    
    <!-- Green arrow for forward combine -->
    <marker id="arrowGreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#2ecc71" />
    </marker>
    
    <!-- Orange arrow for backward pass -->
    <marker id="arrowOrange" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#ff8c42" />
    </marker>
    
    <!-- Light pink arrow for CPU offload -->
    <marker id="arrowPink2" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#FFD0E0" />
    </marker>
    
    <!-- Bidirectional light pink arrow (reverse direction) -->
    <marker id="arrowPink2BidiStart" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M9,0 L9,6 L0,3 z" fill="#FFD0E0" />
    </marker>
    
    <marker id="arrowPink2BidiEnd" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#FFD0E0" />
    </marker>
    
    <!-- Pink arrow for router -->
    <marker id="arrowPink" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#FFB3D9" />
    </marker>
  </defs>
  
  <!-- Title -->
  <text x="650" y="40" fill="#ddd" font-size="32" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">The Sparsity Frontier: Advances in DeepSeek V3 and Kimi K2</text>
  
  <!-- OUTPUT token stream (top) -->
  <text x="50" y="125" fill="#aaa" font-size="18" font-family="Arial, sans-serif">Layer Output:</text>
  
  <circle cx="250" cy="120" r="20" fill="#ffffff" stroke="#666" stroke-width="2"/>
  
  <circle cx="450" cy="120" r="20" fill="#ffffff" stroke="#666" stroke-width="2"/>
  
  <circle cx="650" cy="120" r="20" fill="#ffffff" stroke="#666" stroke-width="2"/>
  
  <circle cx="850" cy="120" r="20" fill="#ffffff" stroke="#666" stroke-width="2"/>
  
  <!-- CPU Infrastructure (top right) - Aligned to output tokens -->
  <!-- CPU RAM box -->
  <rect x="1050" y="100" width="180" height="90" fill="#FFD0E0" stroke="#FFB3D9" stroke-width="3" rx="6"/>
  <text x="1140" y="125" fill="#000" font-size="18" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">CPU RAM</text>
  <text x="1140" y="150" fill="#000" font-size="12" font-family="Arial, sans-serif" font-style="italic" text-anchor="middle">Activation Cache</text>
  <text x="1140" y="170" fill="#000" font-size="12" font-family="Arial, sans-serif" font-style="italic" text-anchor="middle">EMA Tracking</text>
  
  <!-- Streaming Copy Engine -->
  <rect x="1050" y="240" width="180" height="50" fill="#FFD0E0" stroke="#FFB3D9" stroke-width="3" rx="6"/>
  <text x="1140" y="270" fill="#000" font-size="16" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">Streaming Copy Engine</text>
  
  <!-- Arrow from Streaming Copy Engine to CPU RAM -->
  <line x1="1140" y1="200" x2="1140" y2="235" stroke="#FFD0E0" stroke-width="2" marker-end="url(#arrowPink2BidiEnd)" marker-start="url(#arrowPink2BidiStart)"/>
  
  <!-- Shared Expert (Left) - CYAN/TURQUOISE -->
  <rect x="80" y="420" width="70" height="250" fill="#00CED1" stroke="#00A8B5" stroke-width="3" rx="4"/>
  <text x="115" y="538" fill="#000" font-size="16" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">Shared</text>
  <text x="115" y="556" fill="#000" font-size="16" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">Expert</text>
  <text x="115" y="575" fill="#000" font-size="12" font-family="Arial, sans-serif" font-style="italic" text-anchor="middle">(Primary)</text>
  
  <!-- Node labels -->
  <text x="280" y="335" fill="#9370db" font-size="16" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">Node 1</text>
  <text x="500" y="335" fill="#9370db" font-size="16" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">Node 2</text>
  <text x="720" y="335" fill="#9370db" font-size="16" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">Node 3</text>
  <text x="940" y="335" fill="#9370db" font-size="16" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">Node 4</text>
  
  <!-- Comms Buffers - CENTERED on nodes -->
  <rect x="180" y="345" width="200" height="30" fill="#444444" stroke="#ffaa00" stroke-width="2" rx="4"/>
  <text x="280" y="365" fill="#ffaa00" font-size="11" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">Comms Buffer</text>
  
  <rect x="400" y="345" width="200" height="30" fill="#444444" stroke="#ffaa00" stroke-width="2" rx="4"/>
  <text x="500" y="365" fill="#ffaa00" font-size="11" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">Comms Buffer</text>
  
  <rect x="620" y="345" width="200" height="30" fill="#444444" stroke="#ffaa00" stroke-width="2" rx="4"/>
  <text x="720" y="365" fill="#ffaa00" font-size="11" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">Comms Buffer</text>
  
  <rect x="840" y="345" width="200" height="30" fill="#444444" stroke="#ffaa00" stroke-width="2" rx="4"/>
  <text x="940" y="365" fill="#ffaa00" font-size="11" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">Comms Buffer</text>
  
  <!-- Node boundaries -->
  <rect x="180" y="390" width="200" height="320" fill="none" stroke="#7b68ee" stroke-width="2" stroke-dasharray="8,4" rx="8"/>
  <rect x="400" y="390" width="200" height="320" fill="none" stroke="#7b68ee" stroke-width="2" stroke-dasharray="8,4" rx="8"/>
  <rect x="620" y="390" width="200" height="320" fill="none" stroke="#7b68ee" stroke-width="2" stroke-dasharray="8,4" rx="8"/>
  <rect x="840" y="390" width="200" height="320" fill="none" stroke="#7b68ee" stroke-width="2" stroke-dasharray="8,4" rx="8"/>
  
  <!-- Bidirectional arrows from Nodes to Streaming Copy Engine -->
  <line x1="380" y1="360" x2="1050" y2="265" stroke="#FFD0E0" stroke-width="2" stroke-dasharray="6,3" marker-end="url(#arrowPink2BidiEnd)" marker-start="url(#arrowPink2BidiStart)"/>
  <line x1="600" y1="360" x2="1050" y2="265" stroke="#FFD0E0" stroke-width="2" stroke-dasharray="6,3" marker-end="url(#arrowPink2BidiEnd)" marker-start="url(#arrowPink2BidiStart)"/>
  <line x1="790" y1="360" x2="1050" y2="265" stroke="#FFD0E0" stroke-width="2" stroke-dasharray="6,3" marker-end="url(#arrowPink2BidiEnd)" marker-start="url(#arrowPink2BidiStart)"/>
  <line x1="1000" y1="360" x2="1050" y2="265" stroke="#FFD0E0" stroke-width="2" stroke-dasharray="6,3" marker-end="url(#arrowPink2BidiEnd)" marker-start="url(#arrowPink2BidiStart)"/>
  
  <!-- Shared Expert Replica (Right) - CYAN -->
  <rect x="1070" y="420" width="70" height="250" fill="#00CED1" stroke="#00A8B5" stroke-width="3" rx="4"/>
  <text x="1105" y="538" fill="#000" font-size="16" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">Shared</text>
  <text x="1105" y="556" fill="#000" font-size="16" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">Expert</text>
  <text x="1105" y="575" fill="#000" font-size="12" font-family="Arial, sans-serif" font-style="italic" text-anchor="middle">(Replica)</text>
  
  <!-- Router box - Slightly darker pink -->
  <rect x="1180" y="420" width="70" height="250" fill="#FF99CC" stroke="#FF80B3" stroke-width="3" rx="4"/>
  <text x="1215" y="538" fill="#000" font-size="16" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">Router</text>
  <text x="1215" y="560" fill="#000" font-size="12" font-family="Arial, sans-serif" font-style="italic" text-anchor="middle">(top-k gating)</text>
  
  <!-- Expert blocks -->
  <!-- Node 1: experts 0-3 -->
  <!-- Expert 0 (inactive) -->
  <rect x="195" y="420" width="40" height="250" fill="#2a2a2a" stroke="#444" stroke-width="2" rx="4"/>
  <text x="215" y="550" fill="#666" font-size="12" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">E₀</text>
  
  <!-- Expert 1 (active - has backward pass detail) - PASTEL GREEN -->
  <rect x="245" y="420" width="40" height="250" fill="#B4E7CE" stroke="#8FD4B8" stroke-width="2" rx="4"/>
  <text x="265" y="550" fill="#000" font-size="12" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">E₁</text>
  
  <!-- Backward pass box inside E1 - larger, orange background -->
  <rect x="248" y="586" width="34" height="80" fill="#ff8c42" stroke="#ff6600" stroke-width="1" rx="2"/>
  <text x="265" y="631" fill="#000" font-size="11" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">BP</text>
  
  <!-- Expert 2 (active) - PASTEL GREEN -->
  <rect x="295" y="420" width="40" height="250" fill="#B4E7CE" stroke="#8FD4B8" stroke-width="2" rx="4"/>
  <text x="315" y="550" fill="#000" font-size="12" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">E₂</text>
  
  <!-- Expert 3 (inactive) -->
  <rect x="345" y="420" width="40" height="250" fill="#2a2a2a" stroke="#444" stroke-width="2" rx="4"/>
  <text x="365" y="550" fill="#666" font-size="12" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">E₃</text>
  
  <!-- Node 2: experts 4-7 -->
  <rect x="415" y="420" width="40" height="250" fill="#2a2a2a" stroke="#444" stroke-width="2" rx="4"/>
  <text x="435" y="550" fill="#666" font-size="12" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">E₄</text>
  
  <!-- Expert 5 (busy - 2 tokens) -->
  <rect x="465" y="420" width="40" height="250" fill="#ff6b6b" stroke="#cc4444" stroke-width="2" rx="4"/>
  <text x="485" y="550" fill="#fff" font-size="12" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">E₅</text>
  <circle cx="495" cy="440" r="5" fill="#ffd700"/>
  <circle cx="475" cy="440" r="5" fill="#ffd700"/>
  
  <rect x="515" y="420" width="40" height="250" fill="#2a2a2a" stroke="#444" stroke-width="2" rx="4"/>
  <text x="535" y="550" fill="#666" font-size="12" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">E₆</text>
  
  <rect x="565" y="420" width="40" height="250" fill="#2a2a2a" stroke="#444" stroke-width="2" rx="4"/>
  <text x="585" y="550" fill="#666" font-size="12" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">E₇</text>
  
  <!-- Node 3: experts 8-11 -->
  <rect x="635" y="420" width="40" height="250" fill="#2a2a2a" stroke="#444" stroke-width="2" rx="4"/>
  <text x="655" y="550" fill="#666" font-size="12" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">E₈</text>
  
  <rect x="685" y="420" width="40" height="250" fill="#B4E7CE" stroke="#8FD4B8" stroke-width="2" rx="4"/>
  <text x="705" y="550" fill="#000" font-size="12" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">E₉</text>
  
  <rect x="735" y="420" width="40" height="250" fill="#B4E7CE" stroke="#8FD4B8" stroke-width="2" rx="4"/>
  <text x="755" y="550" fill="#000" font-size="12" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">E₁₀</text>
  
  <rect x="785" y="420" width="40" height="250" fill="#B4E7CE" stroke="#8FD4B8" stroke-width="2" rx="4"/>
  <text x="805" y="550" fill="#000" font-size="12" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">E₁₁</text>
  
  <!-- Node 4: experts 12-15 -->
  <rect x="855" y="420" width="40" height="250" fill="#2a2a2a" stroke="#444" stroke-width="2" rx="4"/>
  <text x="875" y="550" fill="#666" font-size="12" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">E₁₂</text>
  
  <!-- Expert 13 (active - with SMALLER memory breakdown boxes) - PASTEL GREEN -->
  <rect x="905" y="420" width="40" height="250" fill="#B4E7CE" stroke="#8FD4B8" stroke-width="2" rx="4"/>
  <text x="925" y="550" fill="#000" font-size="12" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">E₁₃</text>
  
  <!-- Smaller memory breakdown - top 1/3 and bottom 1/3, middle 1/3 free -->
  <!-- Ephemeral State (top 1/3) - with diagonal pattern -->
  <rect x="909" y="424" width="32" height="80" fill="url(#diagonalStripes)" stroke="#888" stroke-width="1" rx="2"/>
  <text x="925" y="469" fill="#fff" font-size="11" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">ES</text>
  
  <!-- Persistent State (bottom 1/3) -->
  <rect x="909" y="586" width="32" height="80" fill="#1a1a1a" stroke="#ffd700" stroke-width="1" rx="2"/>
  <text x="925" y="631" fill="#fff" font-size="11" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">PS</text>
  
  <rect x="955" y="420" width="40" height="250" fill="#2a2a2a" stroke="#444" stroke-width="2" rx="4"/>
  <text x="975" y="550" fill="#666" font-size="12" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">E₁₄</text>
  
  <rect x="1005" y="420" width="40" height="250" fill="#2a2a2a" stroke="#444" stroke-width="2" rx="4"/>
  <text x="1025" y="550" fill="#666" font-size="12" font-family="Arial, sans-serif" font-weight="600" text-anchor="middle">E₁₅</text>
  
  <!-- INPUT token stream (bottom) -->
  <text x="50" y="925" fill="#aaa" font-size="18" font-family="Arial, sans-serif">Layer Input:</text>
  
  <circle cx="250" cy="920" r="20" fill="#ffffff" stroke="#666" stroke-width="2"/>
  
  <circle cx="450" cy="920" r="20" fill="#ffffff" stroke="#666" stroke-width="2"/>
  
  <circle cx="650" cy="920" r="20" fill="#ffffff" stroke="#666" stroke-width="2"/>
  
  <circle cx="850" cy="920" r="20" fill="#ffffff" stroke="#666" stroke-width="2"/>
  
  <!-- PINK arrows from input tokens to Router -->
  <line x1="250" y1="900" x2="1215" y2="670" stroke="#FFB3D9" stroke-width="2" stroke-dasharray="4,2" marker-end="url(#arrowPink)"/>
  <line x1="450" y1="900" x2="1215" y2="670" stroke="#FFB3D9" stroke-width="2" stroke-dasharray="4,2" marker-end="url(#arrowPink)"/>
  <line x1="650" y1="900" x2="1215" y2="670" stroke="#FFB3D9" stroke-width="2" stroke-dasharray="4,2" marker-end="url(#arrowPink)"/>
  <line x1="850" y1="900" x2="1215" y2="670" stroke="#FFB3D9" stroke-width="2" stroke-dasharray="4,2" marker-end="url(#arrowPink)"/>
  
  <!-- FORWARD PASS: Token 1 → Expert 1, Expert 5, Shared (left) -->
  <line x1="250" y1="900" x2="265" y2="680" stroke="#4a9eff" stroke-width="2" marker-end="url(#arrowBlue)"/>
  <line x1="250" y1="900" x2="485" y2="680" stroke="#4a9eff" stroke-width="2" marker-end="url(#arrowBlue)"/>
  <line x1="250" y1="900" x2="115" y2="680" stroke="#4a9eff" stroke-width="2" marker-end="url(#arrowBlue)"/>
  
  <!-- Token 2 → Expert 2, Expert 9, Shared (left) -->
  <line x1="450" y1="900" x2="315" y2="680" stroke="#4a9eff" stroke-width="2" marker-end="url(#arrowBlue)"/>
  <line x1="450" y1="900" x2="705" y2="680" stroke="#4a9eff" stroke-width="2" marker-end="url(#arrowBlue)"/>
  <line x1="450" y1="900" x2="115" y2="680" stroke="#4a9eff" stroke-width="2" marker-end="url(#arrowBlue)"/>
  <text x="460" y="785" fill="#4a9eff" font-size="11" font-family="Arial, sans-serif" font-style="italic">Low Rank Read</text>
  
  <!-- Token 3 → Expert 5, Expert 10, Shared (right) -->
  <line x1="650" y1="900" x2="485" y2="680" stroke="#4a9eff" stroke-width="2" marker-end="url(#arrowBlue)"/>
  <line x1="650" y1="900" x2="755" y2="680" stroke="#4a9eff" stroke-width="2" marker-end="url(#arrowBlue)"/>
  <line x1="650" y1="900" x2="1105" y2="680" stroke="#4a9eff" stroke-width="2" marker-end="url(#arrowBlue)"/>
  
  <!-- Token 4 → Expert 11, Expert 13, Shared (right) -->
  <line x1="850" y1="900" x2="805" y2="680" stroke="#4a9eff" stroke-width="2" marker-end="url(#arrowBlue)"/>
  <line x1="850" y1="900" x2="925" y2="680" stroke="#4a9eff" stroke-width="2" marker-end="url(#arrowBlue)"/>
  <line x1="850" y1="900" x2="1105" y2="680" stroke="#4a9eff" stroke-width="2" marker-end="url(#arrowBlue)"/>
  
  <!-- Pipeline annotation - moved LEFT near shared expert -->
  <text x="50" y="800" fill="#4a9eff" font-size="10" font-family="Arial, sans-serif" font-style="italic">Forward Microbatch</text>
  
  <!-- FORWARD PASS: Experts to output tokens -->
  <!-- Expert 1 → Token 1 -->
  <line x1="265" y1="410" x2="250" y2="150" stroke="#2ecc71" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <text x="460" y="265" fill="#2ecc71" font-size="11" font-family="Arial, sans-serif" font-style="italic">Low Rank</text>
  <text x="450" y="280" fill="#2ecc71" font-size="11" font-family="Arial, sans-serif" font-style="italic">Residual Write</text>
  
  <!-- Expert 2 → Token 2 -->
  <line x1="315" y1="410" x2="450" y2="150" stroke="#2ecc71" stroke-width="2" marker-end="url(#arrowGreen)"/>
  
  <!-- Expert 5 → Token 1, Token 3 -->
  <line x1="485" y1="410" x2="250" y2="150" stroke="#2ecc71" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <line x1="485" y1="410" x2="650" y2="150" stroke="#2ecc71" stroke-width="2" marker-end="url(#arrowGreen)"/>
  
  <!-- Expert 9 → Token 2 -->
  <line x1="705" y1="410" x2="450" y2="150" stroke="#2ecc71" stroke-width="2" marker-end="url(#arrowGreen)"/>
  
  <!-- Expert 10 → Token 3 -->
  <line x1="755" y1="410" x2="650" y2="150" stroke="#2ecc71" stroke-width="2" marker-end="url(#arrowGreen)"/>
  
  <!-- Expert 11 → Token 4 -->
  <line x1="805" y1="410" x2="850" y2="150" stroke="#2ecc71" stroke-width="2" marker-end="url(#arrowGreen)"/>
  
  <!-- Expert 13 → Token 4 -->
  <line x1="925" y1="410" x2="850" y2="150" stroke="#2ecc71" stroke-width="2" marker-end="url(#arrowGreen)"/>
  
  <!-- Shared Expert (left) → Token 1, Token 2 -->
  <line x1="115" y1="410" x2="250" y2="150" stroke="#2ecc71" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <line x1="115" y1="410" x2="450" y2="150" stroke="#2ecc71" stroke-width="2" marker-end="url(#arrowGreen)"/>
  
  <!-- Shared Expert (right) → Token 3, Token 4 -->
  <line x1="1105" y1="410" x2="650" y2="150" stroke="#2ecc71" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <line x1="1105" y1="410" x2="850" y2="150" stroke="#2ecc71" stroke-width="2" marker-end="url(#arrowGreen)"/>
  
  <!-- BACKWARD PASS: Only for Token 1 to ALL its experts (Shared, E1, E5) -->
  <!-- Output Token 1 → Shared Expert (left) -->
  <line x1="240" y1="140" x2="125" y2="410" stroke="#ff8c42" stroke-width="2" stroke-dasharray="4,2" marker-end="url(#arrowOrange)"/>
  
  <!-- Output Token 1 → Expert 1 -->
  <line x1="240" y1="140" x2="255" y2="410" stroke="#ff8c42" stroke-width="2" stroke-dasharray="4,2" marker-end="url(#arrowOrange)"/>
  
  <!-- Output Token 1 → Expert 5 -->
  <line x1="240" y1="140" x2="475" y2="410" stroke="#ff8c42" stroke-width="2" stroke-dasharray="4,2" marker-end="url(#arrowOrange)"/>
  
  <!-- Shared Expert (left) → Input Token 1 -->
  <line x1="125" y1="680" x2="240" y2="900" stroke="#ff8c42" stroke-width="2" stroke-dasharray="4,2" marker-end="url(#arrowOrange)"/>
  
  <!-- Expert 1 → Input Token 1 -->
  <line x1="255" y1="680" x2="240" y2="900" stroke="#ff8c42" stroke-width="2" stroke-dasharray="4,2" marker-end="url(#arrowOrange)"/>
  
  <!-- Expert 5 → Input Token 1 -->
  <line x1="475" y1="680" x2="240" y2="900" stroke="#ff8c42" stroke-width="2" stroke-dasharray="4,2" marker-end="url(#arrowOrange)"/>
  
  <!-- Pipeline annotation on backward - moved LEFT -->
  <text x="40" y="760" fill="#ff8c42" font-size="10" font-family="Arial, sans-serif" font-style="italic">Backward Microbatch</text>
  
  <!-- Annotations on the right side - ALIGNED -->
  <!-- CPU offloading label - Aligned to top of output tokens -->
  <rect x="1380" y="100" width="200" height="60" fill="#FFD0E0" stroke="#FFB3D9" stroke-width="2" rx="6"/>
  <text x="1480" y="122" fill="#000" font-size="15" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">CPU Offloading</text>
  <text x="1480" y="142" fill="#000" font-size="11" font-family="Arial, sans-serif" font-style="italic" text-anchor="middle">(via streaming engine)</text>
  
  <!-- All-to-all combine label -->
  <rect x="1380" y="190" width="200" height="60" fill="#1a1a1a" stroke="#2ecc71" stroke-width="2" rx="6"/>
  <text x="1480" y="212" fill="#2ecc71" font-size="15" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">All-to-All Combine</text>
  <text x="1480" y="232" fill="#2ecc71" font-size="11" font-family="Arial, sans-serif" font-style="italic" text-anchor="middle">(experts → tokens)</text>
  
  <!-- Ephemeral State box -->
  <rect x="1380" y="280" width="200" height="50" fill="url(#diagonalStripes)" stroke="#888" stroke-width="2" rx="6"/>
  <text x="1480" y="302" fill="#fff" font-size="14" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">ES = Ephemeral State</text>
  <text x="1480" y="320" fill="#888" font-size="11" font-family="Arial, sans-serif" font-style="italic" text-anchor="middle">Offloaded/Recomputed</text>
  
  <!-- Persistent State box -->
  <rect x="1380" y="340" width="200" height="50" fill="#1a1a1a" stroke="#888" stroke-width="2" rx="6"/>
  <text x="1480" y="362" fill="#888" font-size="14" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">PS = Persistent State</text>
  <text x="1480" y="380" fill="#888" font-size="11" font-family="Arial, sans-serif" font-style="italic" text-anchor="middle">Params + Optimizer</text>
  
  <!-- Sparse Gradient Flow label -->
  <rect x="1380" y="410" width="200" height="70" fill="#1a1a1a" stroke="#ff8c42" stroke-width="2" rx="6"/>
  <text x="1480" y="437" fill="#ff8c42" font-size="15" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">Sparse Gradient Flow</text>
  <text x="1480" y="462" fill="#ff8c42" font-size="11" font-family="Arial, sans-serif" font-style="italic" text-anchor="middle">(Token 1)</text>
  
  <!-- Backward Pass Details box -->
  <rect x="1380" y="490" width="200" height="70" fill="#333333" stroke="#ff8c42" stroke-width="2" rx="6"/>
  <text x="1480" y="512" fill="#ff8c42" font-size="15" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">Backward Pass</text>
  <text x="1480" y="532" fill="#ddd" font-size="11" font-family="Arial, sans-serif" text-anchor="middle">ActRecompute</text>
  <text x="1480" y="552" fill="#ddd" font-size="11" font-family="Arial, sans-serif" text-anchor="middle">dWeight, dInput</text>
  
  <!-- All-to-all dispatch label -->
  <rect x="1380" y="610" width="200" height="60" fill="#1a1a1a" stroke="#4a9eff" stroke-width="2" rx="6"/>
  <text x="1480" y="632" fill="#4a9eff" font-size="15" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">All-to-All Dispatch</text>
  <text x="1480" y="652" fill="#4a9eff" font-size="11" font-family="Arial, sans-serif" font-style="italic" text-anchor="middle">(tokens → experts)</text>
  
  <!-- Sparsity info -->
  <rect x="1380" y="720" width="200" height="95" fill="#1a1a1a" stroke="#ffd700" stroke-width="2" rx="6"/>
  <text x="1480" y="745" fill="#ffd700" font-size="16" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">Expert Sparsity</text>
  <text x="1480" y="770" fill="#ddd" font-size="14" font-family="Arial, sans-serif" text-anchor="middle">routed = 8 (2 depicted)</text>
  <text x="1480" y="790" fill="#ddd" font-size="14" font-family="Arial, sans-serif" text-anchor="middle">total = 384 (8 depicted)</text>
  <text x="1480" y="810" fill="#ffd700" font-size="16" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">sparsity = 48x</text>
  
  <!-- Legend - Aligned to bottom of input tokens -->
  <rect x="1380" y="835" width="200" height="105" fill="#1a1a1a" stroke="#888" stroke-width="2" rx="6"/>
  <text x="1480" y="860" fill="#ddd" font-size="15" font-family="Arial, sans-serif" font-weight="700" text-anchor="middle">Expert Status</text>
  
  <rect x="1395" y="870" width="25" height="25" fill="#B4E7CE" stroke="#8FD4B8" stroke-width="2" rx="2"/>
  <text x="1430" y="887" fill="#ddd" font-size="12" font-family="Arial, sans-serif">Active</text>
  
  <rect x="1395" y="900" width="25" height="25" fill="#ff6b6b" stroke="#cc4444" stroke-width="2" rx="2"/>
  <text x="1430" y="917" fill="#ddd" font-size="12" font-family="Arial, sans-serif">Busy</text>
  
  <rect x="1495" y="870" width="25" height="25" fill="#2a2a2a" stroke="#444" stroke-width="2" rx="2"/>
  <text x="1530" y="887" fill="#ddd" font-size="12" font-family="Arial, sans-serif">Inactive</text>
</svg>